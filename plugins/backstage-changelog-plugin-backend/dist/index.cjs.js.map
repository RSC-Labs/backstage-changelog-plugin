{"version":3,"file":"index.cjs.js","sources":["../src/lib/changelogReader.ts","../src/service/router.ts","../src/plugin.ts"],"sourcesContent":["/*\n * Copyright 2023 RSC-Labs, https://rsoftcon.com/\n *\n * Licensed under the Mozilla Public License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     https://www.mozilla.org/en-US/MPL/2.0/\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport fs from 'fs-extra';\n\nexport const readChangelogFile = async (\n    changeLogFileReference: string\n) : Promise<string> => {\n    const result = fs.readFileSync(changeLogFileReference);\n    return result.toString('utf8');\n}","/*\n * Copyright 2023 RSC-Labs, https://rsoftcon.com/\n *\n * Licensed under the Mozilla Public License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     https://www.mozilla.org/en-US/MPL/2.0/\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { UrlReader, errorHandler, TokenManager, PluginEndpointDiscovery } from '@backstage/backend-common';\nimport { CatalogClient, CatalogApi } from '@backstage/catalog-client';\nimport { NotFoundError } from '@backstage/errors';\nimport express from 'express';\nimport Router from 'express-promise-router';\nimport { Logger } from 'winston';\nimport { readChangelogFile } from '../lib/changelogReader';\nimport {\n  ANNOTATION_SOURCE_LOCATION,\n  parseLocationRef,\n} from '@backstage/catalog-model';\n\nexport interface RouterOptions {\n  logger: Logger;\n  reader: UrlReader;\n  tokenManager: TokenManager;\n  discovery: PluginEndpointDiscovery,\n  catalogApi?: CatalogApi   \n}\n\nexport async function createRouter(\n  options: RouterOptions,\n): Promise<express.Router> {\n  const { logger, tokenManager, reader, discovery } = options;\n\n  const catalogApi =\n    options.catalogApi ?? new CatalogClient({ discoveryApi: discovery });\n\n  const router = Router();\n  router.use(express.json());\n\n  router.get('/health', (_, response) => {\n    logger.info('PONG!');\n    response.json({ status: 'ok' });\n  });\n\n  router.get('/entity/:namespace/:kind/:name', async (req, res) => {\n    const token = await tokenManager.getToken();\n    const { namespace, kind, name } = req.params;\n    const entity = await catalogApi.getEntityByRef(\n      { namespace, kind, name },\n      token,\n    );\n    if (!entity) {\n      throw new NotFoundError(\n        `No ${kind} entity in ${namespace} named \"${name}\"`,\n      );\n    }\n    const entitySourceLocation = entity?.metadata.annotations?.[ANNOTATION_SOURCE_LOCATION];\n    const changelogFilename = entity?.metadata.annotations?.['changelog-name'];\n    const changelogFileReference = entity?.metadata.annotations?.['changelog-file-ref'];\n\n    if (!changelogFileReference) {\n      if (changelogFilename && entitySourceLocation) {\n        const result = await readChangelogFile(entitySourceLocation + changelogFilename);\n        return res.status(200).json({content: result})\n      } else if (entitySourceLocation) {\n        const { type, target } = parseLocationRef(entitySourceLocation);\n        if (type === 'url') {\n          const result = await reader.readUrl(target + 'CHANGELOG.md');\n          return res.status(200).json({content: (await result.buffer()).toString('utf8')})\n        }\n        if (type === 'file') {\n          const result = await readChangelogFile(target +'CHANGELOG.md');\n          return res.status(200).json({content: result})\n        }\n        return res.status(500).json()\n      } else {\n        return res.status(404).json();\n      }\n    } else {\n      const { type, target } = parseLocationRef(changelogFileReference);\n      if (type === 'url') {\n        const result = await reader.readUrl(target);\n        return res.status(200).json({content: (await result.buffer()).toString('utf8')})\n      }\n      if (type === 'file') {\n        const result = await readChangelogFile(target);\n        return res.status(200).json({content: result})\n      }\n      return res.status(500).json()\n    }\n  });\n\n  router.use(errorHandler());\n  return router;\n}\n","/*\n * Copyright 2023 RSC-Labs, https://rsoftcon.com/\n *\n * Licensed under the Mozilla Public License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     https://www.mozilla.org/en-US/MPL/2.0/\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { loggerToWinstonLogger } from '@backstage/backend-common';\nimport {\n  coreServices,\n  createBackendPlugin,\n} from '@backstage/backend-plugin-api';\nimport { createRouter } from './service/router';\n\n/**\n * Changelog backend plugin\n *\n * @public\n */\nexport const changelogPlugin = createBackendPlugin({\n  pluginId: 'changelog',\n  register(env) {\n    env.registerInit({\n      deps: {\n        logger: coreServices.logger,\n        reader: coreServices.urlReader,\n        httpRouter: coreServices.httpRouter,\n        tokenManager: coreServices.tokenManager,\n        discovery: coreServices.discovery,\n      },\n      async init({ logger, reader, httpRouter, tokenManager, discovery }) {\n        httpRouter.use(\n          await createRouter({\n            logger: loggerToWinstonLogger(logger),\n            reader,\n            tokenManager,\n            discovery\n          }),\n        );\n      },\n    });\n  },\n});"],"names":["fs","CatalogClient","Router","express","_a","NotFoundError","ANNOTATION_SOURCE_LOCATION","parseLocationRef","errorHandler","createBackendPlugin","coreServices","loggerToWinstonLogger"],"mappings":"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"}